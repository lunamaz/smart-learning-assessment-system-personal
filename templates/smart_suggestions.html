{% extends "base.html" %}

{% block title %}智慧建議 - {{ child.nickname }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-lightbulb text-warning me-2"></i>
                    {{ child.nickname }} 的個人化學習建議
                </h2>
                <div>
                    {% if ai_suggestion %}
                    <a href="{{ url_for('generate_report', child_id=child.id) }}" class="btn btn-primary me-2">
                        <i class="fas fa-file-pdf me-2"></i>下載分析報告
                    </a>
                    {% endif %}
                    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>返回學習中心
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 學習表現總覽 -->
    <div class="row mb-3 align-items-stretch">
        <div class="col-lg-8">
            <div class="card summary-card h-100">
                <div class="card-header py-2">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-radar text-primary me-2"></i>
                        學習表現總覽
                    </h5>
                </div>
                <div class="card-body py-3">
                    <div class="row text-center">
                        <div class="col-md-3 mb-2">
                            <div class="performance-metric compact">
                                <i class="fas fa-book-reader fa-lg text-primary mb-1"></i>
                                <h5 class="mb-0">{{ performance_data.total_sessions }}</h5>
                                <p class="text-muted mb-0 small">總學習次數</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="performance-metric compact">
                                <i class="fas fa-hourglass-half fa-lg text-success mb-1"></i>
                                <h5 class="mb-0">{{ "%.1f" | format(performance_data.total_hours) }}</h5>
                                <p class="text-muted mb-0 small">總學習時數</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="performance-metric compact">
                                <i class="fas fa-brain fa-lg text-info mb-1"></i>
                                <h5 class="mb-0">{{ performance_data.avg_attention }}%</h5>
                                <p class="text-muted mb-0 small">平均專注度</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="performance-metric compact">
                                <i class="fas fa-chart-line fa-lg text-warning mb-1"></i>
                                <h5 class="mb-0">
                                    {% if performance_data.improvement_rate > 0 %}
                                        +{{ performance_data.improvement_rate }}%
                                    {% else %}
                                        {{ performance_data.improvement_rate }}%
                                    {% endif %}
                                </h5>
                                <p class="text-muted mb-0 small">進步幅度</p>
                            </div>
                        </div>
                    </div>
                    
                    {% if performance_data.best_subject %}
                    <div class="mt-2 text-center">
                        <div class="alert alert-success mb-0 py-2">
                            <i class="fas fa-trophy me-2"></i>
                            表現最佳科目：<strong>{{ performance_data.best_subject }}</strong>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- 學習者資訊 -->
        <div class="col-lg-4">
            <div class="card summary-card h-100">
                <div class="card-header py-2">
                    <h5 class="mb-0">
                        <i class="fas fa-user-graduate text-success me-2"></i>
                        學習者資訊
                    </h5>
                </div>
                <div class="card-body py-3">
                    <div class="learner-info compact">
                        <div class="info-item py-2">
                            <i class="fas fa-user-tag me-2"></i>
                            <strong>姓名：</strong>{{ child.nickname }}
                        </div>
                        <div class="info-item py-2">
                            <i class="fas fa-birthday-cake me-2"></i>
                            <strong>年齡：</strong>{{ child.age }} 歲
                        </div>
                        <div class="info-item py-2">
                            <i class="fas fa-venus-mars me-2"></i>
                            <strong>性別：</strong>{{ {'male': '男生', 'female': '女生'}[child.gender] }}
                        </div>
                        <div class="info-item py-2">
                            <i class="fas fa-school me-2"></i>
                            <strong>教育階段：</strong>{{ {'elementary': '國小', 'middle': '國中', 'high': '高中'}[child.education_stage] }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 個人化建議區域 -->
    <div class="row">
        <!-- AI個人化建議 -->
        {% if ai_enabled %}
        <div class="col-12 mb-3">
            <div class="card suggestion-card ai-suggestion-card">
                <div class="card-header bg-gradient-ai text-white py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-robot me-2"></i>
                            AI個人化建議
                            <span class="badge bg-light text-dark ms-2">
                                <i class="fas fa-magic me-1"></i>智能分析
                            </span>
                        </h5>
                        {% if not ai_suggestion %}
                        <button id="generateAIBtn" class="btn btn-light btn-sm" onclick="generateAISuggestion()">
                            <i class="fas fa-magic me-1"></i>生成建議
                        </button>
                        {% else %}
                        <button id="regenerateAIBtn" class="btn btn-light btn-sm" onclick="generateAISuggestion()">
                            <i class="fas fa-redo me-1"></i>重新生成
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body py-3 ai-suggestion-body">
                    {% if ai_suggestion %}
                    <!-- 已有 AI 建議 -->
                    <div id="ai-suggestion-content" class="ai-suggestion-content">
                        {{ ai_suggestion | replace('\n', '<br>') | safe }}
                    </div>
                    {% else %}
                    <!-- 尚未生成建議 -->
                    <div id="ai-empty-state" class="text-center py-4">
                        <i class="fas fa-brain fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted mb-2">尚未生成 AI 建議</h5>
                        <p class="text-muted mb-0">點擊「生成建議」按鈕，讓 AI 為 {{ child.nickname }} 分析學習數據並提供個人化建議</p>
                    </div>
                    {% endif %}
                    
                    <!-- AI 載入動畫（初始隱藏） -->
                    <div id="ai-loading" class="text-center" style="display: none;">
                        <div class="ai-thinking-animation mb-3">
                            <div class="thinking-dots">
                                <div class="dot dot1"></div>
                                <div class="dot dot2"></div>
                                <div class="dot dot3"></div>
                            </div>
                        </div>
                        <h5 class="ai-thinking-text mb-2">AI 正在分析學習數據...</h5>
                        <p class="text-muted mb-0">請稍候片刻，我正在為 {{ child.nickname }} 生成個人化建議</p>
                        <div class="progress mt-3" style="height: 6px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                 role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                    
                    <!-- AI 建議內容區域（動態顯示） -->
                    <div id="ai-suggestion-display" class="ai-suggestion-content" style="display: none;">
                        <!-- 這裡會由 JavaScript 填入 AI 建議內容 -->
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- 年齡適性建議 -->
        {% if suggestions.age_appropriate %}
        <div class="col-lg-6 mb-3">
            <div class="card suggestion-card">
                <div class="card-header bg-primary text-white py-2">
                    <h5 class="mb-0">
                        <i class="fas fa-child me-2"></i>
                        年齡適性建議
                    </h5>
                </div>
                <div class="card-body py-3">
                    {% for suggestion in suggestions.age_appropriate %}
                    <div class="suggestion-item compact">
                        <i class="fas fa-check-circle text-primary me-2"></i>
                        {{ suggestion }}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- 學習風格建議 -->
        {% if suggestions.learning_style %}
        <div class="col-lg-6 mb-3">
            <div class="card suggestion-card">
                <div class="card-header bg-success text-white py-2">
                    <h5 class="mb-0">
                        <i class="fas fa-palette me-2"></i>
                        學習風格建議
                    </h5>
                </div>
                <div class="card-body py-3">
                    {% for suggestion in suggestions.learning_style %}
                    <div class="suggestion-item compact">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        {{ suggestion }}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- 專注力提升建議 -->
        {% if suggestions.attention_improvement %}
        <div class="col-lg-6 mb-3">
            <div class="card suggestion-card">
                <div class="card-header bg-info text-white py-2">
                    <h5 class="mb-0">
                        <i class="fas fa-brain me-2"></i>
                        專注力提升建議
                    </h5>
                </div>
                <div class="card-body py-3">
                    {% for suggestion in suggestions.attention_improvement %}
                    <div class="suggestion-item compact">
                        <i class="fas fa-check-circle text-info me-2"></i>
                        {{ suggestion }}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- 時間規劃建議 -->
        {% if suggestions.schedule %}
        <div class="col-lg-6 mb-3">
            <div class="card suggestion-card">
                <div class="card-header bg-warning text-white py-2">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>
                        時間規劃建議
                    </h5>
                </div>
                <div class="card-body py-3">
                    {% for suggestion in suggestions.schedule %}
                    <div class="suggestion-item compact">
                        <i class="fas fa-check-circle text-warning me-2"></i>
                        {{ suggestion }}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- 科目專屬建議 -->
        {% if suggestions.subject_specific %}
        <div class="col-12 mb-3">
            <div class="card suggestion-card">
                <div class="card-header bg-danger text-white py-2">
                    <h5 class="mb-0">
                        <i class="fas fa-book me-2"></i>
                        科目專屬建議
                    </h5>
                </div>
                <div class="card-body py-3">
                    <div class="row">
                        {% for suggestion in suggestions.subject_specific %}
                        <div class="col-md-6 mb-2">
                            <div class="suggestion-item compact">
                                <i class="fas fa-check-circle text-danger me-2"></i>
                                {{ suggestion }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
/* AI建議卡片特殊樣式 */
.ai-suggestion-card {
    border: 2px solid transparent;
    background: linear-gradient(white, white) padding-box,
                linear-gradient(45deg, #667eea 0%, #764ba2 100%) border-box;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.15);
}

.bg-gradient-ai {
    background: linear-gradient(45deg, #667eea 0%, #764ba2 100%) !important;
    position: relative;
    overflow: hidden;
}

.bg-gradient-ai::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

.ai-suggestion-body {
    background: linear-gradient(135deg, #f8f9fc 0%, #e9ecef 100%);
    position: relative;
}

.ai-suggestion-content {
    font-size: 1rem;
    line-height: 1.7;
    color: #2c3e50;
    padding: 1rem;
    background: white;
    border-radius: 8px;
    border-left: 4px solid #667eea;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    position: relative;
}

.ai-suggestion-content::before {
    content: '"';
    position: absolute;
    top: -10px;
    left: 10px;
    font-size: 2rem;
    color: #667eea;
    font-family: serif;
}

.ai-suggestion-content::after {
    content: '"';
    position: absolute;
    bottom: -20px;
    right: 10px;
    font-size: 2rem;
    color: #667eea;
    font-family: serif;
}

/* AI 思考動畫樣式 */
.ai-thinking-animation {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 80px;
}

.thinking-dots {
    display: flex;
    gap: 8px;
}

.dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: linear-gradient(45deg, #667eea, #764ba2);
    animation: thinking 1.4s infinite ease-in-out;
}

.dot1 { animation-delay: -0.32s; }
.dot2 { animation-delay: -0.16s; }
.dot3 { animation-delay: 0s; }

@keyframes thinking {
    0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% {
        transform: scale(1.2);
        opacity: 1;
    }
}

.ai-thinking-text {
    color: #667eea;
    font-weight: 600;
    font-size: 1.1rem;
}

/* 精簡版效能指標 */
.performance-metric.compact {
    padding: 0.75rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 8px;
    transition: transform 0.3s ease;
    border: 1px solid rgba(66, 165, 245, 0.1);
}

.performance-metric.compact:hover {
    transform: translateY(-3px);
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
}

.performance-metric.compact h5 {
    font-size: 1.25rem;
    margin-bottom: 0.25rem;
}

.performance-metric.compact p {
    font-size: 0.75rem;
}

/* 精簡版學習者資訊 */
.learner-info.compact {
    font-size: 0.95rem;
}

.info-item {
    border-bottom: 1px solid rgba(66, 165, 245, 0.1);
    display: flex;
    align-items: center;
}

.info-item:last-child {
    border-bottom: none;
}

.info-item i {
    width: 20px;
    text-align: center;
    color: #42a5f5;
}

/* 精簡版建議卡片 */
.suggestion-card {
    height: 100%;
    transition: transform 0.3s ease;
}

.suggestion-card:hover {
    transform: translateY(-3px);
}

.suggestion-item.compact {
    padding: 0.75rem;
    margin-bottom: 0.4rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 6px;
    line-height: 1.5;
    border-left: 3px solid rgba(66, 165, 245, 0.3);
    font-size: 0.9rem;
}

.suggestion-item.compact:last-child {
    margin-bottom: 0;
}

.card-header {
    font-weight: 600;
}

.card-header.bg-primary {
    background: linear-gradient(45deg, #42a5f5, #1e88e5) !important;
}

.card-header.bg-success {
    background: linear-gradient(45deg, #66bb6a, #4caf50) !important;
}

.card-header.bg-info {
    background: linear-gradient(45deg, #26c6da, #00bcd4) !important;
}

.card-header.bg-warning {
    background: linear-gradient(45deg, #ffb74d, #ff9800) !important;
    color: white !important;
}

.card-header.bg-danger {
    background: linear-gradient(45deg, #ef5350, #f44336) !important;
}

/* 響應式設計 */
@media (max-width: 768px) {
    .performance-metric.compact {
        margin-bottom: 0.5rem;
        padding: 0.5rem;
    }
    
    .performance-metric.compact h5 {
        font-size: 1.1rem;
    }
    
    .performance-metric.compact i {
        font-size: 1.25rem !important;
    }
    
    .suggestion-item.compact {
        padding: 0.6rem;
        font-size: 0.85rem;
    }
    
    .info-item {
        font-size: 0.9rem;
        padding: 0.3rem 0;
    }
    
    .col-md-6.mb-2 {
        margin-bottom: 0.5rem !important;
    }
    
    .ai-suggestion-content {
        font-size: 0.9rem;
        padding: 0.8rem;
    }
    
    .ai-thinking-text {
        font-size: 1rem;
    }
    
    .thinking-dots {
        gap: 6px;
    }
    
    .dot {
        width: 10px;
        height: 10px;
    }
}

@media (max-width: 576px) {
    .performance-metric.compact h5 {
        font-size: 1rem;
    }
    
    .performance-metric.compact i {
        font-size: 1rem !important;
    }
    
    .performance-metric.compact p {
        font-size: 0.7rem;
    }
    
    .suggestion-item.compact {
        padding: 0.5rem;
        font-size: 0.8rem;
    }
    
    .card-header h5 {
        font-size: 0.95rem;
    }
    
    .info-item {
        font-size: 0.85rem;
    }
    
    .ai-suggestion-content {
        font-size: 0.85rem;
        padding: 0.6rem;
    }
    
    .ai-suggestion-content::before,
    .ai-suggestion-content::after {
        font-size: 1.5rem;
    }
    
    .ai-thinking-text {
        font-size: 0.9rem;
    }
    
    .ai-thinking-animation {
        height: 60px;
    }
}
</style>

<script>
async function generateAISuggestion() {
    // 隱藏現有內容
    const emptyState = document.getElementById('ai-empty-state');
    const existingContent = document.getElementById('ai-suggestion-content');
    const loadingDiv = document.getElementById('ai-loading');
    const displayDiv = document.getElementById('ai-suggestion-display');
    const generateBtn = document.getElementById('generateAIBtn');
    const regenerateBtn = document.getElementById('regenerateAIBtn');
    
    // 隱藏空狀態和現有內容
    if (emptyState) emptyState.style.display = 'none';
    if (existingContent) existingContent.style.display = 'none';
    if (displayDiv) displayDiv.style.display = 'none';
    
    // 禁用按鈕
    if (generateBtn) {
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>生成中...';
    }
    if (regenerateBtn) {
        regenerateBtn.disabled = true;
        regenerateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>生成中...';
    }
    
    // 顯示載入動畫
    if (loadingDiv) {
        loadingDiv.style.display = 'block';
    }
    
    try {
        const response = await fetch('/generate_ai_suggestion', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // 隱藏載入動畫
            if (loadingDiv) {
                loadingDiv.style.opacity = '0';
                setTimeout(() => {
                    loadingDiv.style.display = 'none';
                    
                    // 填入AI建議內容
                    if (displayDiv) {
                        displayDiv.innerHTML = result.ai_suggestion.replace(/\n/g, '<br>');
                        displayDiv.style.display = 'block';
                        displayDiv.style.opacity = '0';
                        
                        // 添加淡入效果
                        setTimeout(() => {
                            displayDiv.style.transition = 'opacity 0.5s ease-in';
                            displayDiv.style.opacity = '1';
                        }, 100);
                    }
                    
                    // 更新按鈕狀態
                    if (generateBtn) {
                        generateBtn.style.display = 'none';
                    }
                    if (regenerateBtn) {
                        regenerateBtn.style.display = 'inline-block';
                        regenerateBtn.disabled = false;
                        regenerateBtn.innerHTML = '<i class="fas fa-redo me-1"></i>重新生成';
                    } else {
                        // 如果沒有重新生成按鈕，創建一個
                        const buttonContainer = document.querySelector('.card-header .d-flex');
                        if (buttonContainer) {
                            const newRegenBtn = document.createElement('button');
                            newRegenBtn.id = 'regenerateAIBtn';
                            newRegenBtn.className = 'btn btn-light btn-sm';
                            newRegenBtn.onclick = generateAISuggestion;
                            newRegenBtn.innerHTML = '<i class="fas fa-redo me-1"></i>重新生成';
                            buttonContainer.appendChild(newRegenBtn);
                        }
                    }
                    
                    // 檢查並添加下載 PDF 按鈕
                    const downloadBtn = document.querySelector('a[href*="generate_report"]');
                    if (!downloadBtn) {
                        const buttonContainer = document.querySelector('.d-flex.justify-content-between .div:last-child') || 
                                             document.querySelector('.d-flex.justify-content-between div:last-child');
                        if (buttonContainer) {
                            const newDownloadBtn = document.createElement('a');
                            newDownloadBtn.href = `/generate_report/{{ child.id }}`;
                            newDownloadBtn.className = 'btn btn-primary me-2';
                            newDownloadBtn.innerHTML = '<i class="fas fa-file-pdf me-2"></i>下載分析報告';
                            buttonContainer.insertBefore(newDownloadBtn, buttonContainer.firstChild);
                        }
                    }
                    
                }, 500);
            }
        } else {
            // 顯示錯誤訊息
            if (loadingDiv) {
                loadingDiv.innerHTML = `
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <h5>AI建議生成失敗</h5>
                        <p>${result.message}</p>
                        <button class="btn btn-outline-primary" onclick="generateAISuggestion()">
                            <i class="fas fa-redo me-2"></i>重新嘗試
                        </button>
                    </div>
                `;
            }
            
            // 恢復按鈕狀態
            if (generateBtn) {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-magic me-1"></i>生成建議';
            }
            if (regenerateBtn) {
                regenerateBtn.disabled = false;
                regenerateBtn.innerHTML = '<i class="fas fa-redo me-1"></i>重新生成';
            }
        }
        
    } catch (error) {
        console.error('生成AI建議時發生錯誤:', error);
        
        if (loadingDiv) {
            loadingDiv.innerHTML = `
                <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <h5>網路錯誤</h5>
                    <p>無法連接到AI服務，請檢查網路連線</p>
                    <button class="btn btn-outline-primary" onclick="generateAISuggestion()">
                        <i class="fas fa-redo me-2"></i>重新嘗試
                    </button>
                </div>
            `;
        }
        
        // 恢復按鈕狀態
        if (generateBtn) {
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fas fa-magic me-1"></i>生成建議';
        }
        if (regenerateBtn) {
            regenerateBtn.disabled = false;
            regenerateBtn.innerHTML = '<i class="fas fa-redo me-1"></i>重新生成';
        }
    }
}
</script>
{% endblock %}